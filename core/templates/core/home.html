{% extends "core/base.html" %}
{% block title %}Reelioo | AI Quant Terminal{% endblock %}

{% block content %}

<style>
    /* --- CORE GLASS UI --- */
    .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    .nav-tab { padding: 10px 24px; border-radius: 12px; font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; border: 1px solid transparent; transition: all 0.2s; color: #64748b; background: rgba(255, 255, 255, 0.02); }
    .nav-tab:hover { color: white; border-color: rgba(255, 255, 255, 0.1); }
    .nav-tab.active { background: #1e293b; color: white; border-color: rgba(255, 255, 255, 0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    .metric-box { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; transition: transform 0.2s; }
    .metric-box:hover { border-color: rgba(255,255,255,0.1); transform: translateY(-2px); }

    .btn-primary { background: linear-gradient(to bottom, #3b82f6, #2563eb); border-top: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transition: all 0.1s; }
    .btn-primary:active { transform: translateY(1px); }

    .input-clean { background: transparent; border: none; color: white; width: 100%; outline: none; font-family: 'JetBrains Mono', monospace; text-transform: uppercase; font-weight: 700; }
    .autocomplete-box { position: absolute; top: 100%; left: 0; right: 0; background: #0f172a; border: 1px solid #334155; border-radius: 12px; z-index: 100; max-height: 240px; overflow-y: auto; display: none; }
    .autocomplete-box.active { display: block; }
    .autocomplete-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; color:#cbd5e1; font-size:12px; }
    .autocomplete-item:hover { background: #1e293b; color: white; }

    /* SIGNAL STRIP BAR */
    .signal-strip { height: 6px; border-radius: 99px; background: #1e293b; overflow: hidden; display: flex; }
    .signal-seg { height: 100%; transition: width 0.5s ease; }
    .seg-liq { background: #eab308; } /* Yellow */
    .seg-stop { background: #ef4444; } /* Red */
    .seg-whale { background: #3b82f6; } /* Blue */

    /* MODAL */
    .modal-backdrop { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
    .opt-btn { flex:1; padding:10px; border-radius:8px; border:1px solid #334155; color:#64748b; font-size:10px; font-weight:700; transition:all 0.2s; cursor: pointer; }
    .opt-btn.selected { background:#1e293b; color:white; border-color:#3b82f6; }

    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="max-w-7xl mx-auto pt-8 md:pt-16 pb-20 px-4 w-full">
    <!-- HERO SECTION -->
    <div class="text-center mb-16 relative">
        <div class="inline-block mb-6"><span class="px-4 py-1.5 rounded-full bg-slate-900/80 border border-slate-700/50 text-[10px] font-bold text-slate-300 uppercase tracking-[0.2em] shadow-xl backdrop-blur-sm">The Unfair Advantage</span></div>
        <h1 class="text-5xl md:text-7xl lg:text-8xl font-black text-white mb-6 tracking-tight leading-[0.9]">Institutional Grade.<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400">Radically Simple.</span></h1>
        <p class="text-slate-400 text-base md:text-xl max-w-2xl mx-auto leading-relaxed font-light">Most traders drown in noise. Reelioo filters the Indian market chaos into clear, actionable signal cards using advanced quantitative models and Cognitive Synthesis.</p>
    </div>

    <!-- MAIN TERMINAL -->
    <div class="glass-panel p-1 md:p-1.5 min-h-[600px] flex flex-col relative z-10">
        <div class="bg-[#020617]/90 rounded-[20px] h-full w-full p-6 md:p-8 border border-white/5">

            <!-- TABS -->
            <div class="flex overflow-x-auto pb-4 mb-6 gap-2 border-b border-white/5 no-scrollbar">
                <button onclick="switchTab('EQUITY')" id="tab-EQUITY" class="nav-tab active">EQUITY</button>
                <button onclick="switchTab('FUTURES')" id="tab-FUTURES" class="nav-tab">FUTURES</button>
                <button onclick="switchTab('OPTIONS')" id="tab-OPTIONS" class="nav-tab">OPTIONS</button>
                <button onclick="switchTab('CRYPTO')" id="tab-CRYPTO" class="nav-tab">CRYPTO</button>
            </div>

            <!-- Responsive Grid: 1 col on mobile, 12 on desktop -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- INPUTS -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Ticker Symbol</label>
                        <div class="flex items-center gap-3 bg-[#0b1121] border border-slate-700 rounded-xl px-4 py-3 focus-within:border-blue-500 transition">
                            <i data-lucide="search" class="w-4 h-4 text-slate-500"></i>
                            <input id="symbol-input" class="input-clean" placeholder="RELIANCE" onkeyup="handleSearch(this.value)" autocomplete="off">
                        </div>
                        <div id="search-results" class="autocomplete-box"></div>
                    </div>

                    <!-- OPTIONS PANEL -->
                    <div id="options-inputs" class="hidden space-y-4 p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Contract Type</label>
                            <div class="flex gap-2">
                                <button onclick="setOptType('CE')" id="btn-CE" class="opt-btn selected">CALL (CE)</button>
                                <button onclick="setOptType('PE')" id="btn-PE" class="opt-btn">PUT (PE)</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Expiry</label>
                            <div class="flex gap-2">
                                <button onclick="setExpiry('WEEKLY')" id="btn-WEEKLY" class="opt-btn selected">WEEKLY</button>
                                <button onclick="setExpiry('MONTHLY')" id="btn-MONTHLY" class="opt-btn">MONTHLY</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Strike (Optional)</label>
                            <input type="number" id="strike-input" placeholder="Auto-Detect ATM" class="w-full bg-[#0b1121] border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <div id="style-selector-container">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Strategy Horizon</label>
                        <div id="style-buttons-container" class="flex gap-2 bg-[#0b1121] p-1 rounded-xl border border-slate-800"></div>
                    </div>

                    <input type="hidden" id="current-style" value="SWING">
                    <input type="hidden" id="current-market" value="EQUITY">
                    <input type="hidden" id="opt-type" value="CE">
                    <input type="hidden" id="opt-expiry" value="WEEKLY">
                    <input type="hidden" id="selected-token">
                    <input type="hidden" id="selected-exchange">
                    {% csrf_token %}

                    <div class="pt-4 space-y-3">
                        <button onclick="runAnalysis()" id="btn-analyze" class="btn-primary w-full py-4 rounded-xl text-white font-black text-xs uppercase tracking-[0.15em] flex items-center justify-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4"></i> Run Engine
                        </button>
                        <button onclick="runBacktest()" id="btn-backtest" class="w-full py-3 rounded-xl border border-slate-700 text-slate-400 hover:text-white hover:border-slate-500 transition font-bold text-[10px] uppercase tracking-widest flex items-center justify-center gap-2">
                            <i data-lucide="flask-conical" class="w-3 h-3"></i> Validate Strategy
                        </button>
                    </div>
                </div>

                <!-- RESULTS -->
                <div class="lg:col-span-8 min-h-[500px] bg-[#0b1121] rounded-2xl border border-slate-800 relative overflow-hidden flex flex-col">

                    <!-- EMPTY STATE -->
                    <div id="placeholder-view" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600">
                        <i data-lucide="activity" class="w-12 h-12 opacity-20 mb-4"></i>
                        <p class="text-xs font-bold tracking-widest opacity-50">SYSTEM READY</p>
                    </div>

                    <!-- LOADING -->
                    <div id="loading-view" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-[#0b1121] hidden">
                        <div class="w-8 h-8 border-2 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                        <p class="text-[10px] font-mono text-blue-400 animate-pulse">PROCESSING DATA...</p>
                    </div>

                    <!-- CONTENT -->
                    <div id="results-view" class="hidden flex-col h-full fade-in">
                        <!-- HEADER -->
                        <div class="p-6 md:p-8 border-b border-white/5 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span id="res-market" class="text-[9px] font-bold bg-slate-800 px-2 py-0.5 rounded text-slate-400">MARKET</span>
                                    <span id="res-symbol" class="text-[10px] font-bold text-slate-500 tracking-widest">SYMBOL</span>
                                </div>
                                <!-- Dynamic Responsive Text Size -->
                                <h2 id="res-action" class="text-5xl md:text-6xl lg:text-7xl font-black text-white tracking-tighter">--</h2>
                                <p id="res-label" class="text-xs font-bold text-slate-500 uppercase tracking-widest mt-2">Neutral Bias</p>
                            </div>
                            <div class="text-left md:text-right mt-4 md:mt-0">
                                <div id="res-score" class="text-5xl font-black text-slate-200">0%</div>
                                <div class="text-[9px] font-bold text-slate-600 uppercase tracking-widest mt-1">Confidence</div>
                            </div>
                        </div>

                        <!-- METRICS: Grid 2 on mobile, 4 on desktop -->
                        <div class="grid grid-cols-2 md:grid-cols-4 border-b border-white/5 divide-y md:divide-y-0 divide-x divide-white/5">
                            <div class="p-4"><p id="lbl-1" class="text-[9px] font-bold text-slate-500 uppercase">Entry</p><p id="res-1" class="text-lg font-mono font-bold text-blue-400 mt-1">--</p></div>
                            <div class="p-4"><p id="lbl-2" class="text-[9px] font-bold text-slate-500 uppercase">Target</p><p id="res-2" class="text-lg font-mono font-bold text-emerald-400 mt-1">--</p></div>
                            <div class="p-4"><p id="lbl-3" class="text-[9px] font-bold text-slate-500 uppercase">Stop</p><p id="res-3" class="text-lg font-mono font-bold text-red-400 mt-1">--</p></div>
                            <div class="p-4"><p id="lbl-4" class="text-[9px] font-bold text-slate-500 uppercase">Time</p><p id="res-4" class="text-sm font-bold text-white mt-2">--</p></div>
                        </div>

                        <!-- SIGNAL STRIP -->
                        <div class="px-4 md:px-8 py-6 border-b border-white/5 bg-[#080c16]">
                            <div class="flex justify-between items-end mb-2">
                                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Manipulation Risk</span>
                                <span id="risk-text" class="text-[9px] font-bold text-slate-400">LOW</span>
                            </div>
                            <div class="signal-strip w-full h-2 bg-slate-800 rounded-full overflow-hidden flex">
                                <div id="bar-liq" class="seg-liq" style="width:0%"></div>
                                <div id="bar-stop" class="seg-stop" style="width:0%"></div>
                                <div id="bar-whale" class="seg-whale" style="width:0%"></div>
                            </div>
                            <div class="flex justify-between mt-2 text-[8px] font-mono text-slate-600 uppercase">
                                <span>Liquidity Grab</span>
                                <span>Stop Run</span>
                                <span>Whale Vol</span>
                            </div>
                        </div>

                        <!-- AI NOTE + FACTOR BREAKDOWN -->
                        <div class="flex-grow grid grid-cols-1 md:grid-cols-2 bg-[#0b1121] divide-y divide-white/5 md:divide-y-0 md:divide-x md:divide-white/5">
                            <div class="p-6 md:p-8">
                                <div class="flex items-center gap-2 mb-4">
                                    <i data-lucide="bot" class="w-4 h-4 text-blue-500"></i>
                                    <span class="text-[10px] font-bold text-blue-500 uppercase tracking-widest">Analyst Desk Note</span>
                                </div>
                                <div id="res-comment" class="space-y-2 text-sm leading-relaxed text-slate-300">--</div>
                            </div>
                            <div class="p-6 md:p-8">
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4">Factor Breakdown</p>
                                <div id="factors-grid" class="space-y-5"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PREMIUM MARKETING SECTION (RESTORED) -->
    <div class="mt-24 mb-24 relative">
        <div class="grid md:grid-cols-3 gap-8 relative z-10">
            <div class="group p-8 rounded-3xl bg-slate-900/40 border border-white/5 hover:border-blue-500/30 transition duration-500 hover:bg-slate-900/60 hover:shadow-2xl hover:shadow-blue-500/10">
                <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center mb-6 group-hover:scale-110 transition duration-300 border border-blue-500/20">
                    <i data-lucide="globe" class="w-6 h-6 text-blue-400"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-3">Indian Multi-Asset Engine</h3>
                <p class="text-sm text-slate-400 leading-relaxed">
                    From <strong>Dalal Street</strong> equities to <strong>WazirX</strong> crypto flows and <strong>NFO</strong> options trends. One terminal to decode the Indian ecosystem with uniform institutional logic.
                </p>
            </div>
            <div class="group p-8 rounded-3xl bg-slate-900/40 border border-white/5 hover:border-purple-500/30 transition duration-500 hover:bg-slate-900/60 hover:shadow-2xl hover:shadow-purple-500/10">
                <div class="w-12 h-12 rounded-2xl bg-purple-500/10 flex items-center justify-center mb-6 group-hover:scale-110 transition duration-300 border border-purple-500/20">
                    <i data-lucide="cpu" class="w-6 h-6 text-purple-400"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-3">Cognitive Market Synthesis</h3>
                <p class="text-sm text-slate-400 leading-relaxed">
                    Powered by our <strong>Neural Synthesis Engine</strong>. We deliver a senior analyst's desk note explaining <em>structure, risk, and execution nuance</em> in plain English.
                </p>
            </div>
            <div class="group p-8 rounded-3xl bg-slate-900/40 border border-white/5 hover:border-emerald-500/30 transition duration-500 hover:bg-slate-900/60 hover:shadow-2xl hover:shadow-emerald-500/10">
                <div class="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center mb-6 group-hover:scale-110 transition duration-300 border border-emerald-500/20">
                    <i data-lucide="shield-check" class="w-6 h-6 text-emerald-400"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-3">Risk-First Architecture</h3>
                <p class="text-sm text-slate-400 leading-relaxed">
                    Amateurs focus on returns; pros focus on risk. Reelioo dynamically adjusts stop-losses based on <strong>Volatility Regimes</strong> and <strong>Tail Risk</strong> to protect your capital first.
                </p>
            </div>
        </div>
    </div>

    <!-- RISK WARNING -->
    <div class="text-center pb-8 border-t border-white/5 pt-8">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded border border-red-500/20 bg-red-500/5 mb-3">
            <i data-lucide="alert-triangle" class="w-3 h-3 text-red-500"></i>
            <span class="text-[10px] font-bold text-red-400 uppercase tracking-widest">Risk Warning</span>
        </div>
        <p class="text-[10px] text-slate-500 max-w-3xl mx-auto leading-relaxed">
            IMPORTANT DISCLAIMER: Reelioo is an AI-powered technical analysis tool for educational purposes only. We are <strong class="text-red-400">NOT SEBI</strong> registered investment advisor. Trading stocks, derivatives, and crypto involves a high degree of risk and you may lose your entire capital. The "Confidence Score" is a mathematical probability derived from past data and does not guarantee future results. Please consult a certified financial advisor before taking any trades.
        </p>
    </div>
</div>

<!-- BACKTEST MODAL -->
<div id="backtest-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closeBacktest()"></div>

    <div id="backtest-content" class="relative bg-[#0f172a] border border-white/10 rounded-2xl w-full max-w-2xl p-8 shadow-2xl scale-95 opacity-0 transition-all duration-300 transform">
        <!-- Header -->
        <div class="flex justify-between items-start mb-8 border-b border-white/5 pb-6">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="px-2 py-1 rounded bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-bold uppercase tracking-widest">Strategy Report</span>
                    <span id="bt-symbol" class="text-xs font-bold text-slate-500 tracking-widest">--</span>
                </div>
                <h3 class="text-3xl font-black text-white tracking-tight">Backtest Results</h3>
            </div>
            <button onclick="closeBacktest()" class="p-2 hover:bg-white/10 rounded-full transition text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-[#0b1121] p-4 rounded-xl border border-white/5 hover:border-emerald-500/30 transition">
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Win Rate</p>
                <p id="bt-winrate" class="text-2xl font-mono font-bold text-emerald-400">--%</p>
            </div>
            <div class="bg-[#0b1121] p-4 rounded-xl border border-white/5 hover:border-blue-500/30 transition">
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Net Profit</p>
                <p id="bt-pnl" class="text-2xl font-mono font-bold text-white">--%</p>
            </div>
            <div class="bg-[#0b1121] p-4 rounded-xl border border-white/5">
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Total Trades</p>
                <p id="bt-trades" class="text-2xl font-mono font-bold text-blue-400">--</p>
            </div>
            <div class="bg-[#0b1121] p-4 rounded-xl border border-white/5">
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Profit Factor</p>
                <p id="bt-pf" class="text-xl font-mono font-bold text-slate-300">--</p>
            </div>
            <div class="bg-[#0b1121] p-4 rounded-xl border border-white/5 hover:border-red-500/30 transition">
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Max Drawdown</p>
                <p id="bt-dd" class="text-xl font-mono font-bold text-red-400">--%</p>
            </div>
            <div class="bg-[#0b1121] p-4 rounded-xl border border-white/5">
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Avg Trade</p>
                <p id="bt-avg" class="text-xl font-mono font-bold text-slate-300">--%</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center pt-6 border-t border-white/5">
            <p class="text-[10px] text-slate-500 font-mono">
                <i data-lucide="check-circle" class="w-3 h-3 inline mr-1 text-emerald-500"></i>
                Event-Driven Simulation (Includes 0.05% Slippage & Fees)
            </p>
        </div>
    </div>
</div>

<!-- ERROR MODAL -->
<div id="error-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeError()"></div>
    <div class="bg-slate-900 border border-red-500/30 rounded-xl w-full max-w-sm p-6 relative z-10 shadow-2xl text-center">
        <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i></div>
        <h3 class="text-white font-bold mb-2">Analysis Failed</h3>
        <p id="error-msg" class="text-sm text-slate-400 mb-6">Error details.</p>
        <button onclick="closeError()" class="w-full py-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-white font-bold text-xs uppercase transition">Dismiss</button>
    </div>
</div>

<script>
    let activeTabName = "EQUITY";
    const tabConfig = {
        'EQUITY': { placeholder: 'RELIANCE', styles: ['INTRADAY', 'SWING', 'LONG_TERM'], labels: ['ENTRY', 'TARGET', 'STOP', 'TIME'] },
        'FUTURES': { placeholder: 'NIFTY', styles: ['INTRADAY', 'SWING'], labels: ['ENTRY', 'TARGET', 'STOP', 'LOT MULTIPLIER'] },
        'OPTIONS': { placeholder: 'NIFTY', styles: ['INTRADAY', 'SWING'], labels: ['PREMIUM', 'TARGET', 'THETA RISK', 'STRIKE'] },
        'CRYPTO': { placeholder: 'BTCINR', styles: ['INTRADAY', 'SWING'], labels: ['ENTRY', 'TARGET', 'STOP', 'LIQUIDITY RISK'] }
    };

    function switchTab(name) {
        activeTabName = name;
        const cfg = tabConfig[name];
        document.querySelectorAll('.nav-tab').forEach(b => {
            b.classList.remove('active');
            if(b.id === `tab-${name}`) b.classList.add('active');
        });
        document.getElementById('symbol-input').placeholder = cfg.placeholder;
        document.getElementById('symbol-input').value = "";

        // Show/Hide Options Inputs
        if(name==='OPTIONS') document.getElementById('options-inputs').classList.remove('hidden');
        else document.getElementById('options-inputs').classList.add('hidden');

        renderStyles(cfg.styles);
        document.getElementById('results-view').classList.add('hidden');
        document.getElementById('placeholder-view').classList.remove('hidden');
    }

    function renderStyles(styles) {
        const c = document.getElementById('style-buttons-container');
        c.innerHTML = '';
        styles.forEach(s => {
            const btn = document.createElement('button');
            btn.className = 'flex-1 py-2.5 rounded-lg text-[10px] font-bold uppercase transition text-slate-500 hover:text-white';
            if(s === document.getElementById('current-style').value) btn.classList.add('bg-slate-800', 'text-white', 'border', 'border-slate-700');
            btn.textContent = s.replace('_', ' ');
            btn.onclick = (e) => { e.preventDefault(); document.getElementById('current-style').value = s; renderStyles(styles); };
            c.appendChild(btn);
        });
    }

    function setOptType(t) { document.getElementById('opt-type').value=t; document.getElementById('btn-CE').classList.toggle('selected', t==='CE'); document.getElementById('btn-PE').classList.toggle('selected', t==='PE'); }
    function setExpiry(e) { document.getElementById('opt-expiry').value = e; document.getElementById('btn-WEEKLY').classList.toggle('selected', e==='WEEKLY'); document.getElementById('btn-MONTHLY').classList.toggle('selected', e==='MONTHLY'); }
    function showError(m) { document.getElementById('error-msg').innerText = m; document.getElementById('error-modal').classList.remove('hidden'); }
    function closeError() { document.getElementById('error-modal').classList.add('hidden'); }

    async function runAnalysis() {
        const symbol = document.getElementById('symbol-input').value;
        if(!symbol) return showError("Enter a ticker symbol.");

        const btn = document.getElementById('btn-analyze');
        btn.innerHTML = "PROCESSING..."; btn.disabled = true;
        document.getElementById('loading-view').classList.remove('hidden');

        try {
            const payload = {
                symbol, token: document.getElementById('selected-token').value,
                market_type: activeTabName, trade_style: document.getElementById('current-style').value,
                expiry: document.getElementById('opt-expiry').value, strike: document.getElementById('strike-input').value,
                opt_type: document.getElementById('opt-type').value
            };
            const res = await fetch('/api/analyze/market/', {
                method: 'POST', headers: {'Content-Type':'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error);

            document.getElementById('placeholder-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');

            // Header
            document.getElementById('res-symbol').innerText = data.symbol;
            document.getElementById('res-market').innerText = activeTabName;
            document.getElementById('res-score').innerText = Math.round(data.score) + "%";

            // COLOR CODED BIAS & LABEL
            const act = document.getElementById('res-action');
            const label = document.getElementById('res-label');
            act.innerText = data.direction;

            // Responsive text sizing for Action
            let actionClasses = "text-5xl md:text-6xl lg:text-7xl font-black tracking-tighter drop-shadow-2xl ";

            if(data.direction.includes('BULL') || data.direction.includes('BUY')) {
                act.className = actionClasses + "text-emerald-400";
                label.innerText = "Bullish Bias";
                label.className = "text-xs font-bold text-emerald-500 uppercase tracking-widest mt-2";
            } else if(data.direction.includes('BEAR') || data.direction.includes('SELL')) {
                act.className = actionClasses + "text-red-500";
                label.innerText = "Bearish Bias";
                label.className = "text-xs font-bold text-red-500 uppercase tracking-widest mt-2";
            } else {
                act.className = actionClasses + "text-slate-400";
                label.innerText = "Neutral Bias";
                label.className = "text-xs font-bold text-slate-500 uppercase tracking-widest mt-2";
            }

            // Labels
            const cfg = tabConfig[activeTabName];
            [1,2,3,4].forEach(i => document.getElementById(`lbl-${i}`).innerText = cfg.labels[i-1]);

            // Metrics
            const ex = data.extras || {};
            if(activeTabName === 'OPTIONS') {
                document.getElementById('res-1').innerText = ex.ltp_info?.ltp || "0.00";
                document.getElementById('res-2').innerText = ex.target_premium || "0.00";
                document.getElementById('res-3').innerText = ex.theta_risk || "MODERATE";
                document.getElementById('res-4').innerText = ex.strike || "--";
            } else {
                document.getElementById('res-1').innerText = data.entry?.toFixed(2);
                document.getElementById('res-2').innerText = data.target?.toFixed(2);
                document.getElementById('res-3').innerText = data.stop?.toFixed(2);
                document.getElementById('res-4').innerText = (activeTabName==='CRYPTO' && ex.liquidity_grab_risk) ? ex.liquidity_grab_risk : "NORMAL";
            }

            // SIGNAL STRIP LOGIC
            const liq = (ex.liquidity_grab_risk === 'HIGH') ? 33 : 0;
            const stop = (ex.stop_run_risk === 'HIGH') ? 33 : 0;
            const whale = (ex.whale_activity_z > 2) ? 33 : 0;

            document.getElementById('bar-liq').style.width = liq + "%";
            document.getElementById('bar-stop').style.width = stop + "%";
            document.getElementById('bar-whale').style.width = whale + "%";

            const totalRisk = liq + stop + whale;
            const rt = document.getElementById('risk-text');
            if(totalRisk > 60) { rt.innerText = "CRITICAL"; rt.className = "text-[9px] font-bold text-red-500"; }
            else if(totalRisk > 30) { rt.innerText = "ELEVATED"; rt.className = "text-[9px] font-bold text-orange-500"; }
            else { rt.innerText = "NORMAL"; rt.className = "text-[9px] font-bold text-emerald-500"; }

            // Comment
            document.getElementById('res-comment').innerHTML = data.ai_comment;

            // Factor Breakdown (RESTORED)
            const mlEdge = parseFloat(data.ml_edge || 50);
            let visualEdge = Math.max(0, (mlEdge - 50) * 4); if (mlEdge < 50) visualEdge = Math.max(0, (50 - mlEdge) * 4);
            const trendScore = parseFloat(data.trend_score || 0);

            document.getElementById("factors-grid").innerHTML = `
                <div class="flex justify-between items-center text-xs"><span class="text-slate-500 font-bold uppercase tracking-wider">ML EDGE</span><div class="flex items-center gap-3"><div class="w-24 h-1.5 bg-slate-900 rounded-full overflow-hidden border border-slate-800"><div class="h-full bg-blue-500" style="width: ${visualEdge}%"></div></div><span class="font-mono text-white font-bold">${mlEdge.toFixed(1)}%</span></div></div>
                <div class="flex justify-between items-center text-xs"><span class="text-slate-500 font-bold uppercase tracking-wider">TREND</span><div class="flex items-center gap-3"><div class="w-24 h-1.5 bg-slate-900 rounded-full overflow-hidden border border-slate-800"><div class="h-full ${trendScore>0?'bg-emerald-500':'bg-red-500'}" style="width: ${Math.min(Math.abs(trendScore), 100)}%"></div></div><span class="font-mono text-white font-bold">${trendScore.toFixed(1)}</span></div></div>
                <div class="flex justify-between items-center text-xs"><span class="text-slate-500 font-bold uppercase tracking-wider">VOLATILITY</span><div class="flex items-center gap-3"><span class="font-mono text-white font-bold">${data.volatility_regime}</span></div></div>
            `;

        } catch(e) { showError(e.message); } finally {
            document.getElementById('loading-view').classList.add('hidden');
            btn.innerHTML = "RUN ENGINE"; btn.disabled = false;
            try { lucide.createIcons(); } catch(e){}
        }
    }

    async function runBacktest() {
        const symbol = document.getElementById('symbol-input').value;
        if(!symbol) return showError("Enter symbol first.");
        const btn = document.getElementById('btn-backtest');
        btn.innerHTML = "SIMULATING..."; btn.disabled = true;
        try {
            const payload = { symbol, token: document.getElementById('selected-token').value, market_type: activeTabName, trade_style: document.getElementById('current-style').value };
            const res = await fetch('/api/analyze/backtest/', { method:'POST', headers:{'Content-Type':'application/json', 'X-CSRFToken':document.querySelector('[name=csrfmiddlewaretoken]').value}, body:JSON.stringify(payload) });
            const data = await res.json();
            if(data.error) throw new Error(data.error);

            // Using IDs from your pasted HTML code
            document.getElementById('bt-winrate').innerText = (data.win_rate||0) + "%";
            document.getElementById('bt-pnl').innerText = (data.net_profit_percent||0).toFixed(1) + "%";
            document.getElementById('bt-pnl').className = `text-2xl font-mono font-bold ${(data.net_profit_percent>=0)?'text-emerald-400':'text-red-400'}`;
            document.getElementById('bt-dd').innerText = (data.max_drawdown_percent||0).toFixed(1) + "%";
            document.getElementById('bt-trades').innerText = data.total_trades||0;
            document.getElementById('bt-pf').innerText = (data.profit_factor||0).toFixed(2);
            document.getElementById('bt-avg').innerText = (data.avg_trade_percent||0).toFixed(2) + "%";

            const m = document.getElementById('backtest-modal');
            const c = document.getElementById('backtest-content');
            m.classList.remove('hidden');
            setTimeout(() => { c.classList.remove('scale-95','opacity-0'); c.classList.add('scale-100','opacity-100'); }, 10);
        } catch(e) { showError(e.message); } finally { btn.innerHTML = "VALIDATE STRATEGY"; btn.disabled = false; }
    }

    function closeBacktest() {
        const m = document.getElementById('backtest-modal');
        const c = document.getElementById('backtest-content');
        c.classList.remove('scale-100','opacity-100'); c.classList.add('scale-95','opacity-0');
        setTimeout(() => m.classList.add('hidden'), 300);
    }

    // Search
    let searchTimer;
    async function handleSearch(q) {
        document.getElementById("selected-token").value = "";
        const box = document.getElementById("search-results");
        if (q.length < 2) { box.classList.remove('active'); return; }
        clearTimeout(searchTimer);
        searchTimer = setTimeout(async () => {
            try {
                const res = await fetch(`/api/search-symbol/?q=${encodeURIComponent(q)}&market_type=${activeTabName}`);
                const data = await res.json();
                box.innerHTML = "";
                if (data.length > 0) {
                    box.classList.add('active');
                    data.forEach(item => {
                        const div = document.createElement("div");
                        div.className = "autocomplete-item";
                        div.innerHTML = `<span class="font-bold text-white">${item.symbol}</span> <span class="text-xs text-slate-500 ml-2">${item.name||''}</span>`;
                        div.onclick = () => {
                            document.getElementById("symbol-input").value = item.symbol;
                            document.getElementById("selected-token").value = item.token || "";
                            document.getElementById("selected-exchange").value = item.exchange || "";
                            box.classList.remove('active');
                        };
                        box.appendChild(div);
                    });
                } else box.classList.remove('active');
            } catch (e) { box.classList.remove('active'); }
        }, 200);
    }

    switchTab('EQUITY');
    try { lucide.createIcons(); } catch(e){}
</script>
{% endblock %}